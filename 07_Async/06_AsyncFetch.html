<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Async + Fetch </title>

<style>
    body { background-color: black; color: aliceblue ;font-family: Arial; padding: 20px; }
    #loading, #loading2, #loading3, #loading4, #loading5, #loading6 {
    color: red;
    display: none;
    }

    #dataDiv, #dataDiv2, #dataDiv3, #dataDiv4, #dataDiv5, #dataDiv6 {
    margin-top: 20px;
    }
</style>

</head>
<body>

<!-- 1     -->
<button id="btn1">Fetch Data</button>
<p id="loading">Loading...</p>
<div id="dataDiv"></div> <hr>

<!-- 2 -->
<button id="btn2">Fetch Data</button>
<p id="loading2">Loading...</p>
<div id="dataDiv2"></div> <hr>

<!-- 3 -->
<button id="btn3">Fetch Data</button>
<p id="loading3">Loading...</p>
<div id="dataDiv3"></div> <hr>

<!-- 4 -->
<button id="btn4">No Abort (Observe Stale)</button>
<p id="loading4">Loading...</p>
<div id="dataDiv4"></div> <hr>

<!-- 5 -->
<button id="btn5">HTTP Discipline Test (404)</button>
<p id="loading5">Loading...</p>
<div id="dataDiv5"></div> <hr>

<!-- 6 -->
<button id="btn6">Loading State Failure Test</button>
<p id="loading6">Loading...</p>
<div id="dataDiv6"></div> <hr>

<script>

//1.	Simulate slow API → observe UI freezing patterns.

const btn1 = document.getElementById("btn1");
const loading = document.getElementById("loading");
const dataDiv = document.getElementById("dataDiv");

async function slowFetch(url) {
    const response = await fetch(url);

    await new Promise((resolve) => {
        setTimeout(() => {
            resolve();
        }, 1000);
    });

    return response;
}

btn1.addEventListener("click", async () => {
    console.log("Click triggered");

    loading.style.display = "block";

    try{
        const response = await slowFetch(
            "https://jsonplaceholder.typicode.com/posts/1" //Q1

        );

        if(!response.ok){
            throw new Error(`HTTP error: ${response.status}`);
            
        }

        const data = await response.json();

        console.log("Rendering data");

        dataDiv.textContent = "Title: " + data.title + " | Time: " + Date.now();

    } catch (err){
        console.error("Error:", err)
    } finally{
        loading.style.display = "none";
    }
});

//2.	Cancel in-flight request when user re-clicks.

const btn2 = document.getElementById("btn2");
const loading2 = document.getElementById("loading2");
const dataDiv2 = document.getElementById("dataDiv2");

let controller = null;

btn2.addEventListener("click", async() => {

    if(controller){
        controller.abort();
    }

    controller = new AbortController();

    loading2.style.display = "block";
    dataDiv2.textContent = "";

    try{
        const response = await fetch(
            "https://jsonplaceholder.typicode.com/posts/1",
      {
        signal: controller.signal
      }
        );

    if(!response.ok){
        throw new Error(`HTTP Error: ${response.status}`);
        
    }

    const data = await response.json();

    dataDiv2.textContent = "Title: " + data.title + " | Time: " + Date.now();

    } catch (err) {

    if (err.name === "AbortError") {
      console.log("Request cancelled");
      return; // Don't show as real error
    }

    dataDiv2.textContent = "Error: " + err.message;
    console.error(err);

  } finally {

    loading2.style.display = "none";

  }
});

//3.	Trigger multiple fetch calls rapidly.

const btn3 = document.getElementById("btn3");
const loading3 = document.getElementById("loading3");
const dataDiv3 = document.getElementById("dataDiv3");

btn3.addEventListener("click", async () => {
    console.log("Click triggered at: ", Date.now());

    loading3.style.display = "block";

    try{

        const response = await fetch("https://jsonplaceholder.typicode.com/posts/1");
    

    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status}`);
    }

    await new Promise(resolve => setTimeout(resolve, 2000));

    const data = await response.json();

    console.log("Rendering at:", Date.now());

    dataDiv3.textContent =
      "Title: " + data.title + " | Time: " + Date.now();

  } catch (err) {
    console.error(err);
  } finally {
    loading3.style.display = "none";
  }
});

//4.	Remove abort logic → observe stale overwrites.

const btn4 = document.getElementById("btn4");
const loading4 = document.getElementById("loading4");
const dataDiv4 = document.getElementById("dataDiv4");

btn4.addEventListener("click", async () => {

  loading4.style.display = "block";

  try {
    const response = await fetch(
      "https://jsonplaceholder.typicode.com/posts/1"
    );

    await new Promise(resolve => setTimeout(resolve, 2000));

    const data = await response.json();

    dataDiv4.textContent =
      "Title: " + data.title + " | Time: " + Date.now();

  } catch (err) {
    console.error(err);
  } finally {
    loading4.style.display = "none";
  }
});

//5.	Proper HTTP error discipline.

const btn5 = document.getElementById("btn5");
const loading5 = document.getElementById("loading5");
const dataDiv5 = document.getElementById("dataDiv5");

btn5.addEventListener("click", async () => {

  loading5.style.display = "block";
  dataDiv5.textContent = "";

  try {

    const response = await fetch(
      "https://jsonplaceholder.typicode.com/invalid-route"
    );

    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status}`);
    }

    const data = await response.json();

    dataDiv5.textContent = data.title;

  } catch (err) {

    dataDiv5.textContent = "Error: " + err.message;
    console.error("Handled error:", err);

  } finally {
    loading5.style.display = "none";
  }

});

//6.	Loading state correctness under failure.

const btn6 = document.getElementById("btn6");
const loading6 = document.getElementById("loading6");
const dataDiv6 = document.getElementById("dataDiv6");

btn6.addEventListener("click", async () => {

  loading6.style.display = "block";
  dataDiv6.textContent = "";

  try {

    const response = await fetch(
      "https://invalid-domain-example-xyz.com"
    );

    const data = await response.json();

    dataDiv6.textContent = data.title;

  } catch (err) {

    dataDiv6.textContent = "Network Error Occurred";
    console.error("Network failure:", err);

  } finally {

    loading6.style.display = "none";

  }

});


</script>

</body>
</html>